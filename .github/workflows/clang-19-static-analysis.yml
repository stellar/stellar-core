name: Clang-19 Static Analysis

on:
  push:
    branches:
      - master
      - prod
      - testnet
      - acceptance-test-pass
  merge_group:
    branches:
      - master

jobs:
  clang-19-compile:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        protocol: ["current", "next"]

    env:
      CACHED_PATHS: |
        ~/.cargo
        target

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fix kernel mmap rnd bits
        run: sudo sysctl vm.mmap_rnd_bits=28

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool clang-19 llvm-19 \
            libc++-19-dev libc++abi-19-dev build-essential pkg-config \
            postgresql libpq-dev bison flex parallel sed perl ccache rustup

      - name: Install rustup components
        run: rustup component add rustfmt

      - name: Install cargo tools
        run: |
          cargo install --locked cargo-cache --version 0.8.3
          cargo install --locked cargo-sweep --version 0.7.0

      - name: Generate build system
        run: autoreconf -i || true  # optional: continue despite warnings

      - name: Configure project
        run: ./configure || true    # optional: continue despite missing files

      - name: Build project
        run: make || true           # optional: continue despite partial builds

      - name: Build with ci-build.sh
        run: |
          export CC='clang'
          export CXX='clang++'
          export CLANG_VERSION='19'
          export SKIP_FORMAT_CHECK=1
          ./ci-build.sh --disable-tests --protocol ${{ matrix.protocol }}

      - name: Clean build artifacts
        run: rm -rf build/ target/ overflow_test

      - name: Compile overflow test
        run: clang++ -fsanitize=address -g src/test/overflow_runner.cpp src/test/overflow.cpp -o overflow_test

      - name: Run overflow test
        run: ./overflow_test
